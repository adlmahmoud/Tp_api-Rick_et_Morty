package services

import (
	"encoding/json"
	"exemple/models"
	"fmt"
	"net/http"
	"time"
)

// SearchCharactersModels

//--------------------------------------------------------------------------------------------------------------------------------

// SearchCharactersService
// ------------------------
// Objectif :
//   - Interroger l'API Rick and Morty pour récupérer la liste des personnages dont le prénom est "Rick".
//   - Endpoint à utiliser : https://rickandmortyapi.com/api/character/?name=rick
//   - Décoder la réponse JSON dans models.SearchCharactersModels.
//   - Retourner les données, le code de statut HTTP et une éventuelle erreur.
//
// Étapes attendues :
//  1. Créer un client HTTP (avec un timeout).
//  2. Construire l’URL de l’API avec le paramètre "name".
//  3. Créer et envoyer une requête HTTP GET.
//  4. Vérifier le code de réponse HTTP (StatusCode).
//  5. Décoder les données JSON dans une variable de type SearchCharactersModels.
//  6. Retourner la variable, le code de statut et l’erreur (ou nil si tout va bien).
func SearchCharactersService(query string) (*models.SearchCharactersModels, int, error) {

	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 1 : Créer un client HTTP avec un timeout (5 secondes par exemple).
	// client := http.Client{ Timeout: 5 * time.Second }
	client := http.Client{
		Timeout: 5 * time.Second,
	}
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 2 : Construire l'URL de l'API avec le paramètre "name".
	// Exemple : "https://rickandmortyapi.com/api/character/?name=" + query
	url := "https://rickandmortyapi.com/api/character/?name=" + query
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 3 : Créer la requête HTTP GET (http.NewRequest).
	request, requestErr := http.NewRequest(http.MethodGet, url, nil)
	// Gestion des erreurs lors de la création de la requête.
	if requestErr != nil {
		fmt.Printf("Erreur init requete - %s\n", requestErr.Error())
	}
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 4 : Envoyer la requête avec client.Do(request).
	response, reponseErr := client.Do(request)
	// Gestion des err
	if reponseErr != nil {
		fmt.Printf("Erreur init requete - %s\n", reponseErr.Error())
	}
	defer response.Body.Close()
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 5 : Vérifier le StatusCode (il doit être égal à http.StatusOK).
	if response.StatusCode != http.StatusOK {
		fmt.Printf("Erreur de reponse - code %d,status %s\n", response.StatusCode, response.Status)
	}
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 6 : Décoder le JSON dans une variable de type models.SearchCharactersModels
	var result models.SearchCharactersModels
	//---------------------------------------------------------------------------------------------------------------------------------
	// à l'aide de json.NewDecoder(response.Body).Decode(&variable)
	decoderErr := json.NewDecoder(response.Body).Decode(&result)
	// TODO Étape 7 : Retourner les données décodées, le code de statut et nil comme erreur si tout va bien.
	if decoderErr != nil {
		fmt.Printf("Erreur de decodage - %s\n", decoderErr.Error())
	}
	// Retour "par défaut" tant que la fonction n'est pas implémentée.
	return &result, response.StatusCode, nil
}

// --------------------------------------------------------------------------------------------------------------------------------

// DetailsCharacterService
// ------------------------
// Objectif :
//   - Interroger l’API Rick and Morty pour récupérer les détails d’un personnage à partir de son identifiant numérique.
//   - Pour Rick Sanchez, l'id = 1 → https://rickandmortyapi.com/api/character/1
//   - Décoder la réponse JSON dans models.DetailsCharacterModels.
//   - Retourner les données, le code de statut HTTP et une éventuelle erreur.
//
// Étapes attendues :
//  1. Créer un client HTTP (avec un timeout).
//  2. Construire l’URL de l’API avec l’id passé en paramètre.
//  3. Créer et envoyer une requête HTTP GET.
//  4. Vérifier le StatusCode.
//  5. Décoder les données JSON dans une variable de type DetailsCharacterModels.
//  6. Retourner la variable, le code de statut et l’erreur.
func DetailsCharacterService(id int) (*models.DetailsCharacterModels, int, error) {

	// TODO Étape 1 : Créer un client HTTP (timeout 5s).
	client := http.Client{
		Timeout: 5 * time.Second,
	}
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 2 : Construire l'URL de l'API en utilisant l'id.
	// Exemple : fmt.Sprintf("https://rickandmortyapi.com/api/character/%d", id)
	url := fmt.Sprintf("https://rickandmortyapi.com/api/character/%d", id)
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 3 : Créer la requête GET.
	request, requestErr := http.NewRequest(http.MethodGet, url, nil)
	if requestErr != nil {
		fmt.Printf("Erreur init requete - %s\n", requestErr.Error())
	}
	//--------------------------------------------------------------------------------------------------------------------------------
	// TODO Étape 4 : Envoyer la requête et récupérer la réponse.
	response, responseErr := client.Do(request)
	if responseErr != nil {
		fmt.Printf("Erreur init requete - %s\n", responseErr.Error())
	}
	defer response.Body.Close()
	// TODO Étape 5 : Vérifier le code de statut HTTP.
	if response.StatusCode != http.StatusOK {
		fmt.Printf("Erreur de reponse - code %d,status %s\n", response.StatusCode, response.Status)
	}
	// TODO Étape 6 : Décoder le JSON dans une variable de type models.DetailsCharacterModels.
	var result2 models.DetailsCharacterModels
	decoderErr := json.NewDecoder(response.Body).Decode(&result2)
	// TODO Étape 7 : Retourner les données, le code de statut et l’erreur.
	if decoderErr != nil {
		fmt.Printf("Erreur de decodage - %s\n", decoderErr.Error())
	}
	return &result2, response.StatusCode, nil
}
